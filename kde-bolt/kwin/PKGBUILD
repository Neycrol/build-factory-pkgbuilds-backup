# Maintainer: neycrol <330578697@qq.com>
pkgname=kwin-git-bolt
pkgver=6.4.90.r564.gadf0d882bf
pkgrel=1
pkgdesc="KDE Window Manager (Git) - Native + ThinLTO + BOLT Ready (Hermetic Build)"
arch=(x86_64)
options=(!strip debug !lto)
url='https://invent.kde.org/plasma/kwin'
license=(LGPL)
depends=(
  kdecoration
  breeze
  glibc
  gcc-libs
  qt6-base
  qt6-declarative
  qt6-sensors
  libinput
  libxkbcommon
  mesa
  libdrm
  lcms2
  libdisplay-info
  libxcvt
  hwdata
  wayland
)
makedepends=(
  git
  extra-cmake-modules
  clang
  lld
  llvm
  cmake
  ninja
  python
  qt6-tools
  mesa-utils
  meson
  wayland-protocols
  plasma-wayland-protocols
  # KF6 components needed for build
  kauth
  kidletime
  ksvg
  vulkan-headers
)
provides=(kwin)
conflicts=(kwin kwin-git)

source=(
  "git+https://invent.kde.org/plasma/kwin.git"
  "git+https://invent.kde.org/libraries/plasma-wayland-protocols.git"
  "git+https://gitlab.freedesktop.org/wayland/wayland-protocols.git"
)
sha256sums=('SKIP' 'SKIP' 'SKIP')

pkgver() {
  cd kwin
  git describe --long --tags | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  mkdir -p "$srcdir/fake-root"
}
build() {
  # === 1. ç‰©ç†æé™å‚æ•° ===
  export CC=clang
  export CXX=clang++
  export CFLAGS="-march=native -O3 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=2 -flto=thin -fno-semantic-interposition"
  export CXXFLAGS="$CFLAGS"
  export LDFLAGS="-fuse-ld=lld -Wl,-O3 -Wl,--as-needed -Wl,--emit-relocs -flto=thin"

  local _fake_root="$srcdir/fake-root"

  # === 2. ç¼–è¯‘ Plasma Wayland Protocols (CMake) ===
  msg2 "ğŸ—ï¸ Building bundled plasma-wayland-protocols..."
  cmake -B build-plasma-proto -S plasma-wayland-protocols -G Ninja \
    -DCMAKE_INSTALL_PREFIX="$_fake_root" \
    -DCMAKE_BUILD_TYPE=Release
  cmake --build build-plasma-proto
  cmake --install build-plasma-proto

  # === 3. ç¼–è¯‘ Wayland Protocols (Meson) ===
  msg2 "ğŸ—ï¸ Building bundled wayland-protocols..."
  rm -rf build-std-proto
  meson setup build-std-proto wayland-protocols \
    --prefix="$_fake_root" \
    --libdir=lib \
    --buildtype=release
  meson compile -C build-std-proto
  meson install -C build-std-proto

  # === 4. è·¯å¾„æ³¨å…¥ (ä¿®æ­£ç‰ˆ) ===

  # A. æŸ¥æ‰¾ Plasma åè®® Config
  _plasma_proto_dir=$(find "$_fake_root" -name "PlasmaWaylandProtocolsConfig.cmake" -exec dirname {} \; | head -n 1)
  if [ -z "$_plasma_proto_dir" ]; then
    error "Failed to locate Plasma protocols config!"
    return 1
  fi
  msg2 "ğŸ”’ Locked Plasma Protocols to: $_plasma_proto_dir"

  # B. è®¾ç½® PKG_CONFIG_PATH (ä¿®æ­£ï¼šåªè¿½åŠ ï¼Œä¸è¦†ç›–)
  # è¿™æ · KWin æ—¢èƒ½æ‰¾åˆ°æˆ‘ä»¬çš„æ–°åè®®ï¼Œä¹Ÿèƒ½æ‰¾åˆ°ç³»ç»Ÿçš„åŸºç¡€ Wayland
  export PKG_CONFIG_PATH="$_fake_root/lib/pkgconfig:$_fake_root/share/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig"

  # âŒ åˆ é™¤äº† PKG_CONFIG_LIBDIRï¼Œè¿™æ˜¯å¯¼è‡´æ‰¾ä¸åˆ°ç³»ç»Ÿåº“çš„å…ƒå‡¶

  msg2 "ğŸ”’ Injecting PKG_CONFIG_PATH..."

  # === 5. ç¼–è¯‘ KWin ===
  msg2 "ğŸ—ï¸ Building KWin..."

  # -DWayland_DATADIR: æ˜¾å¼å‘Šè¯‰ CMake ç³»ç»Ÿ Wayland åè®®åœ¨å“ªé‡Œ (åŒä¿é™©)
  cmake -B build -S kwin -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DPlasmaWaylandProtocols_DIR="$_plasma_proto_dir" \
    -DWayland_DATADIR="/usr/share/wayland" \
    -DBUILD_TESTING=OFF \
    -DKWIN_BUILD_DECO_QPA=ON

  cmake --build build
}

package() {
  DESTDIR="$pkgdir" cmake --install build
}
