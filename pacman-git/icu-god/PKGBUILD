# Maintainer: Andreas Radke <andyrtr@archlinux.org>
# Contributor: Art Gramlich <art@gramlich-net.com>

pkgname=icu-god
pkgver=78.1
pkgrel=1
pkgdesc="International Components for Unicode library (God Mode Shadow Build in /opt)"
arch=(x86_64)
url="https://icu.unicode.org"
license=('LicenseRef-Unicode-3.0'
         'BSD-2-Clause'
         'BSD-3-Clause'
         'NAIST-2003')
depends=('gcc-libs' 'glibc' 'sh')
makedepends=('python')
# We do NOT conflict with icu, we shadow it in /opt
provides=(libicu-god) 
source=(https://github.com/unicode-org/icu/releases/download/release-${pkgver}/icu4c-${pkgver}-sources.tgz{,.asc}
        ICU-22132.patch)
sha512sums=('c366398fdb50afc6355a8c45ed1d68a18eaa5f07a5d1c4555becbcfb9d4073e65ebe1e9caf24b93779b11b36cd813c98dd59e4b19f008851f25c7262811c112d'
            'SKIP'
            '1178062ccfcf7ecc698c64132b3612e73f9c4b0bbfaa668ae2039f3eb4cb2722d0b08a9f45b057da10def7a308d5c8d14c0c644892e7f11092c9cc488c850ab7')
validpgpkeys=('E52F07877A5805F9AF4AB0ACD46C5610D06E7001') # ICU Release Robot <icu-robot@unicode.org>

build() {
  # --- MISAKA GOD MODE INJECTION ---
  msg2 "Injecting God Mode Compiler and Flags..."
  export CC="/opt/gcc-git-god/bin/gcc"
  export CXX="/opt/gcc-git-god/bin/g++"
  
  export GOD_FLAGS="-O3 -march=native -flto=auto -fgraphite-identity -floop-nest-optimize -pipe"
  # BOLT requires --emit-relocs
  export GOD_LDFLAGS="-L/opt/gcc-git-god/lib64 -Wl,-rpath,/opt/gcc-git-god/lib64 -flto=auto -Wl,--emit-relocs"

  export CFLAGS="$GOD_FLAGS"
  export CXXFLAGS="$GOD_FLAGS"
  export LDFLAGS="$GOD_LDFLAGS"
  export LD_LIBRARY_PATH="/opt/gcc-git-god/lib64:$LD_LIBRARY_PATH"
  # --- END INJECTION ---

  cd icu/source
  ./configure --prefix=/opt/gcc-git-god \
    --libdir=/opt/gcc-git-god/lib64 \
    --sysconfdir=/etc \
    --mandir=/opt/gcc-git-god/share/man \
    --enable-static \
    --enable-shared
  make
}

package() {
  cd icu/source
  make DESTDIR="${pkgdir}" install

  # --- MISAKA GOD MODE INJECTION: BOLT POST-INSTALL ---
  export BOLT_BIN="/mnt/data/misaka_workspace/toolchains/android-ndk-r29/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-bolt"
  if [ -f "$BOLT_BIN" ]; then
    msg2 "Initiating BOLT Optimization on libicuuc.so (The core library)..."
    
    # 采样：运行 icuinfo
    mkdir -p bolt_profile_run && cd bolt_profile_run
    LD_LIBRARY_PATH="/opt/gcc-git-god/lib64:../lib" perf record -e cycles:u -j any,u -- ../bin/icuinfo > /dev/null 2>&1 || true
    cd ..

    export PERF2BOLT="${BOLT_BIN%llvm-bolt}perf2bolt"
    if [ -f "$PERF2BOLT" ]; then
      # 寻找实际的库文件
      REAL_LIB=$(find "$pkgdir"/opt/gcc-git-god/lib64/ -name "libicuuc.so.*.*" -type f | head -n 1)
      if [ -n "$REAL_LIB" ]; then
        msg2 "Applying BOLT to $(basename "$REAL_LIB")..."
        "$PERF2BOLT" "$REAL_LIB" -p bolt_profile_run/perf.data -o icu.fdata
        "$BOLT_BIN" "$REAL_LIB" -o ./libicuuc.so.bolt -data icu.fdata -reorder-blocks=ext-tsp -reorder-functions=cdsort -split-functions -split-all-cold -dyno-stats
        cp ./libicuuc.so.bolt "$REAL_LIB"
      fi
    fi
  fi
  # --- END BOLT ---

  # Install license
  install -Dm644 ../LICENSE "${pkgdir}"/opt/gcc-git-god/share/licenses/${pkgname}/LICENSE
}

check() {
  cd icu/source
  make check
}

package() {
  cd icu/source
  make DESTDIR="${pkgdir}" install

  # Install license
  install -Dm644 ../LICENSE "${pkgdir}"/usr/share/licenses/${pkgname}/LICENSE
}
