# Maintainer: neycrol <330578697@qq.com>
pkgname=bcachefs-kernel-dkms-git
pkgver=2025.12.09.r0.g0000000
pkgrel=1
pkgdesc="Bcachefs kernel module (DKMS) built directly from upstream kernel tree (fs/bcachefs)"
arch=('x86_64')
url="https://bcachefs.org/"
license=('GPL')
depends=('dkms')
makedepends=('git')
conflicts=('bcachefs-dkms' 'bcachefs-git' 'bcachefs-source-git')
provides=('bcachefs-dkms')
source=(
    "dkms.conf.in"
    "Makefile.dkms"
)
# 注意：对于本地文件，最好生成真实的校验和。
# 保存文件后，在终端运行 'updpkgsums' 命令，它会自动替换下面的 SKIP
sha256sums=('SKIP' 'SKIP')

pkgver() {
    # 健壮性检查：防止目录不存在报错
    if [ -d "$srcdir/bcachefs-kernel" ]; then
        cd "$srcdir/bcachefs-kernel"
        # 这种格式是 AUR 最标准的 Git 版本号格式
        printf "%s.r%s.g%s" \
            "$(git show -s --format=%cd --date=format:%Y%m%d HEAD)" \
            "$(git rev-list --count HEAD)" \
            "$(git rev-parse --short HEAD)"
    else
        # 第一次运行时的回退版本
        printf "2025.12.09.r0.g0000000"
    fi
}

prepare() {
    local _kernel_repo="https://github.com/koverstreet/bcachefs.git"
    local _kernel_dir="$srcdir/bcachefs-kernel"

    # --- 1. 初始化仓库 (如果不存在) ---
    if [ ! -d "$_kernel_dir" ]; then
        msg2 "Initializing sparse checkout..."
        mkdir -p "$_kernel_dir"
        cd "$_kernel_dir"
        git init
        git remote add origin "$_kernel_repo"
        git config core.sparseCheckout true
    else
        cd "$_kernel_dir"
    fi

    # --- 2. 配置稀疏检出 (每次都刷新配置，防止漏文件) ---
    echo "fs/bcachefs/" > .git/info/sparse-checkout
    echo "include/trace/events/bcachefs.h" >> .git/info/sparse-checkout
    
    # --- 3. 拉取代码 ---
    msg2 "Pulling latest kernel source..."
    git pull --depth=1 origin master

    # --- 4. 准备构建环境 ---
    rm -rf "$srcdir/build"
    mkdir -p "$srcdir/build"

    # 复制 fs/bcachefs 目录结构到 build/fs/bcachefs
    # 使用 install -d 比 mkdir -p 更规范
    install -d "$srcdir/build/fs"
    cp -r "$_kernel_dir/fs/bcachefs" "$srcdir/build/fs/"

    # 复制 include 目录 (如果有)
    if [ -d "$_kernel_dir/include" ]; then
        cp -r "$_kernel_dir/include" "$srcdir/build/"
    fi

    # 注入配置
    cp "$srcdir/dkms.conf.in" "$srcdir/build/dkms.conf"
    cp "$srcdir/Makefile.dkms" "$srcdir/build/Makefile"

    # 改名 Kbuild (防止与 Wrapper 冲突)
    if [ -f "$srcdir/build/fs/bcachefs/Makefile" ]; then
        msg2 "Renaming upstream Makefile to Kbuild..."
        mv "$srcdir/build/fs/bcachefs/Makefile" "$srcdir/build/fs/bcachefs/Kbuild"
    fi
}

package() {
    # 动态写入版本号到 dkms.conf
    # 我们先在 build 目录改好，再复制，逻辑更清晰
    sed -i "s/@PKGVER@/${pkgver}/g" "$srcdir/build/dkms.conf"

    # 安装到 /usr/src/bcachefs-<version>
    local install_dir="$pkgdir/usr/src/bcachefs-${pkgver}"
    install -d "$install_dir"
    
    # 整体复制
    cp -r "$srcdir/build/"* "$install_dir/"
}
