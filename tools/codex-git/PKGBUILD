# Maintainer: misaka <misaka@local>

pkgname=codex-git
_pkgname=codex
pkgver=r2601.13c42a077
pkgrel=1
pkgdesc="OpenAI Codex CLI (Rust, git)"
arch=('x86_64')
url="https://github.com/openai/codex"
license=('Apache-2.0')
depends=('gcc-libs' 'openssl' 'zlib' 'libseccomp')
makedepends=('git' 'rust' 'cargo' 'clang' 'lld' 'pkgconf')
options=('!debug')
provides=('codex')
conflicts=('codex')
source=("git+https://github.com/openai/codex.git")
sha256sums=('SKIP')

pkgver() {
  cd "$_pkgname"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {
  cd "$_pkgname/codex-rs"

  # Native O3 + LTO for Rust and C deps. MLGO/CSSPGO/BOLT/Propeller are optional
  # and require external profiles/tooling via env vars.
  local _cflags="-O3 -pipe -fno-plt -march=native -mtune=native"
  export CFLAGS="${CFLAGS:-} ${_cflags}"
  export CXXFLAGS="${CXXFLAGS:-} ${_cflags}"

  local _rustflags="-C opt-level=3 -C target-cpu=native -C codegen-units=1"
  if [[ -n ${CODEX_PGO_GENERATE:-} ]]; then
    _rustflags+=" -C profile-generate=${CODEX_PGO_GENERATE}"
  elif [[ -n ${CODEX_PGO_USE:-} ]]; then
    _rustflags+=" -C profile-use=${CODEX_PGO_USE} -C llvm-args=-pgo-warn-missing-function"
  fi
  if [[ -n ${CODEX_MLGO_MODEL:-} ]]; then
    _rustflags+=" -C llvm-args=-enable-mlgo -C llvm-args=-mlgo-model=${CODEX_MLGO_MODEL}"
  fi
  if [[ -n ${CODEX_CSSPGO_PROFILE:-} ]]; then
    _rustflags+=" -C llvm-args=-enable-cs-profile -C llvm-args=-cs-profile-file=${CODEX_CSSPGO_PROFILE}"
  fi
  _rustflags+=" --remap-path-prefix=${srcdir}=/usr/src -C link-arg=-fuse-ld=bfd"
  export CARGO_PROFILE_RELEASE_CODEGEN_UNITS="1"
  export CARGO_PROFILE_RELEASE_LTO="${CODEX_RUST_LTO:-thin}"
  export CARGO_PROFILE_RELEASE_OPT_LEVEL="3"

  export RUSTFLAGS="${_rustflags}"
  cargo build --release -p tree-sitter -p tree-sitter-bash -p ring

  local _ts_lib
  local _ts_bash_lib
  local _ring_lib
  _ts_lib=$(find target/release/build -path '*tree-sitter-*/out/libtree-sitter.a' -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)
  _ts_bash_lib=$(find target/release/build -path '*tree-sitter-bash-*/out/libtree-sitter-bash.a' -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)
  _ring_lib=$(find target/release/build -path '*ring-*/out/libring_core_*.a' ! -name '*_test*' -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)
  if [[ -z ${_ts_lib} || -z ${_ts_bash_lib} || -z ${_ring_lib} ]]; then
    echo "Failed to locate tree-sitter/ring static libs." >&2
    return 1
  fi

  cargo rustc --release -p codex-cli --bin codex -- \
    -C link-arg=-Wl,--start-group \
    -C link-arg="${_ts_lib}" \
    -C link-arg="${_ts_bash_lib}" \
    -C link-arg="${_ring_lib}" \
    -C link-arg=-Wl,--end-group

  if [[ -n ${CODEX_BOLT_PROFILE:-} ]]; then
    if ! command -v llvm-bolt >/dev/null; then
      echo "BOLT requested but llvm-bolt not found in PATH." >&2
      return 1
    fi
    llvm-bolt target/release/codex \
      -o target/release/codex.bolt \
      -data="${CODEX_BOLT_PROFILE}" \
      -reorder-blocks=ext-tsp \
      -reorder-functions=hfsort+ \
      -split-functions=3 \
      -split-all-cold \
      -split-eh \
      -dyno-stats
    mv target/release/codex.bolt target/release/codex
  fi
}

package() {
  cd "$_pkgname/codex-rs"

  install -Dm755 target/release/codex "$pkgdir/usr/bin/codex"
  install -Dm644 "$srcdir/$_pkgname/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  install -Dm644 "$srcdir/$_pkgname/NOTICE" "$pkgdir/usr/share/licenses/$pkgname/NOTICE"
}
