# Maintainer: neycrol <330578697@qq.com>
pkgname=fish-git-pgo-bolt
pkgver=4.2.1.r226.g67d78fb25
pkgrel=1
pkgdesc="Fish Shell (Rust) - PGO + Fat LTO + Codegen=1 + BOLT Optimized"
arch=(x86_64)
url="https://fishshell.com"
license=(GPL2)
depends=(glibc gcc-libs ncurses pcre2)
makedepends=(git cmake ninja clang lld rust bolt) # ç¡®ä¿è£…äº† llvm-bolt
provides=(fish)
conflicts=(fish fish-git)
source=("git+https://github.com/fish-shell/fish-shell.git")
sha256sums=('SKIP')

pkgver() {
  cd fish-shell
  git describe --long --tags | sed 's/^//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  # å‡†å¤‡ BOLT æ•°æ®ç›®å½•
  mkdir -p "$srcdir/bolt_data"
}

build() {
  # === 1. ç¯å¢ƒå‡†å¤‡ (ä½¿ç”¨ç³»ç»Ÿå·¥å…·) ===
  export CC=clang
  export CXX=clang++
  # å¼ºåˆ¶ä½¿ç”¨ LLD é“¾æ¥å™¨ (æ”¯æŒ BOLT æ‰€éœ€çš„é‡å®šä½)
  export LDFLAGS="-fuse-ld=lld"

  # === 2. Stage 1: PGO æ’æ¡©ç¼–è¯‘ ===
  msg2 "ğŸš€ Starting PGO Stage 1: Instrumentation..."
  rm -rf build-pgo

  # RUSTFLAGS æ³¨å…¥ï¼š
  # -Cprofile-generate: æ’æ¡©
  # -Ctarget-cpu=native: ç‰©ç†ç‰¹åŒ–
  export RUSTFLAGS="-Cprofile-generate=$srcdir/pgo_data -Ctarget-cpu=native"

  cmake -B build-pgo -S fish-shell -G Ninja \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=Release \
    -DWITH_GETTEXT=OFF

  cmake --build build-pgo

  # === 3. Stage 2: ç‰¹è®­ (PGO Training) ===
  msg2 "ğŸ‹ï¸â€â™‚ï¸ Training Fish (PGO)..."

  export LLVM_PROFILE_FILE="$srcdir/pgo_data/fish-%p-%m.profraw"

  # æ¨¡æ‹Ÿé«˜å¼ºåº¦ä½¿ç”¨
  echo 'for i in (seq 1 5000); string match -r ".*" "test_$i" >/dev/null; end' > train.fish

  for i in {1..20}; do
    ./build-pgo/fish --no-config train.fish > /dev/null 2>&1
    ./build-pgo/fish --no-config -c "complete -C 'git comm'" > /dev/null 2>&1
    ./build-pgo/fish --no-config -c "exit" > /dev/null 2>&1
  done

  # === 4. Stage 3: æé™å‚æ•°ç¼–è¯‘ (PGO Use + Fat LTO + Codegen=1) ===
  msg2 "ğŸ”¥ Starting Stage 3: Extreme Compilation..."

  # åˆå¹¶ PGO æ•°æ®
  llvm-profdata merge -output="$srcdir/fish.profdata" "$srcdir/pgo_data"

  # ç»ˆæ Rust å‚æ•°ï¼š
  # -Cprofile-use: æ³¨å…¥ PGO æ•°æ®
  # -Clto=fat: å…¨å±€èƒ– LTO (æè‡´ä¼˜åŒ–)
  # -Ccodegen-units=1: å•çº¿ç¨‹ä»£ç ç”Ÿæˆ (æè‡´ä¼˜åŒ–)
  # -Cpanic=abort: å»é™¤å›æº¯ (æè‡´ç²¾ç®€)
  # -Clink-arg=-Wl,--emit-relocs: ä¿ç•™é‡å®šä½ä¿¡æ¯ (ä¸º BOLT åšå‡†å¤‡)
  export RUSTFLAGS="-Cprofile-use=$srcdir/fish.profdata -Ctarget-cpu=native -Clto=fat -Ccodegen-units=1 -Cpanic=abort -Clink-arg=-Wl,--emit-relocs"

  # æ¸…é™¤æ—§æ„å»º
  rm -rf build-pgo

  cmake -B build-pgo -S fish-shell -G Ninja \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=Release \
    -DWITH_GETTEXT=OFF

  cmake --build build-pgo

  # === 5. Stage 4: BOLT ç‰©ç†é‡æ’ (The Final Touch) ===
  msg2 "âš¡ Starting BOLT Optimization..."

  # 5.1 å½•åˆ¶ BOLT æ•°æ®
  # æˆ‘ä»¬ç”¨åˆšæ‰ç¼–å¥½çš„ fish å†è·‘ä¸€éè®­ç»ƒè„šæœ¬ï¼Œè¿™æ¬¡ç”¨ perf å½•
  # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ sudo æƒé™ï¼Œmakepkg ç¯å¢ƒä¸‹å¯èƒ½éœ€è¦æ— å¯†ç  sudoï¼Œæˆ–è€…æ‰‹åŠ¨æ‰§è¡Œ
  # å¦‚æœè¿™é‡ŒæŠ¥é”™ï¼Œå¯ä»¥æ³¨é‡Šæ‰ BOLT éƒ¨åˆ†ï¼Œåªç”¨ PGO+LTO ä¹Ÿå¾ˆå¼ºäº†

  # å‡è®¾ä½ æœ‰ sudo æƒé™ (æˆ–è€…åœ¨ fakeroot å¤–é¢è·‘)
  # è¿™é‡Œä¸ºäº†è„šæœ¬è‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·ç¯å¢ƒå…è®¸ perf

  # å¤åˆ¶ä¸€ä»½å‡ºæ¥å½•åˆ¶
  cp build-pgo/fish fish.orig

  # å¯åŠ¨å½•åˆ¶ (åå°)
  # -F pid: åªè®°å½• fish çš„ PID æ²¡æ³•æå‰çŸ¥é“ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ -c (å‘½ä»¤) æ¨¡å¼
  # å½•åˆ¶ 20 ç§’è¶³å¤Ÿäº†
  sudo perf record -e cycles:u -j any,u -o "$srcdir/bolt_data/fish.data" -- \
    ./fish.orig --no-config train.fish > /dev/null 2>&1

  # 5.2 è½¬æ¢ä¸ä¼˜åŒ–
  # å°† perf æ•°æ®è½¬ä¸º BOLT æ ¼å¼
  sudo perf2bolt ./fish.orig -p "$srcdir/bolt_data/fish.data" -o "$srcdir/bolt_data/fish.fdata" --ignore-build-id

  # æ‰§è¡Œ BOLT
  # -reorder-blocks=ext-tsp: æ ¸å¿ƒç®—æ³•
  # -reorder-functions=hfsort: ç”¨æˆ·æ€å¯ä»¥å¼€ï¼
  # -split-functions: ç”¨æˆ·æ€å¯ä»¥å¼€ï¼
  # -icf=1: ä»£ç æŠ˜å 
  sudo llvm-bolt ./fish.orig -o ./fish.bolt \
    -data "$srcdir/bolt_data/fish.fdata" \
    -reorder-blocks=ext-tsp \
    -reorder-functions=hfsort \
    -split-functions \
    -split-all-cold \
    -icf=1 \
    -dyno-stats

  # 5.3 æ›¿æ¢
  mv ./fish.bolt build-pgo/fish
}

package() {
  DESTDIR="$pkgdir" cmake --install build-pgo
}
