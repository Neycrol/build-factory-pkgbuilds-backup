# Maintainer: neycrol <330578697@qq.com>
pkgname=fish-git-pgo-bolt
pkgver=4.2.1.r226.g67d78fb25
pkgrel=1
pkgdesc="Fish Shell (Rust) - PGO + Fat LTO + Codegen=1 + BOLT Optimized"
arch=(x86_64)
url="https://fishshell.com"
license=(GPL2)
depends=(glibc gcc-libs ncurses pcre2)
makedepends=(git cmake ninja unzip clang llvm lld rust)
provides=(fish)
conflicts=(fish fish-git)
source=("git+https://github.com/fish-shell/fish-shell.git")
sha256sums=('SKIP')

pkgver() {
  cd fish-shell
  git describe --long --tags | sed 's/^//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  mkdir -p "$srcdir/bolt_data"
}

build() {
  # === 0. Download Android NDK for LLVM tools (llvm-bolt, etc.) ===
  NDK_VERSION="r27c"
  NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
  NDK_DIR="$srcdir/android-ndk-${NDK_VERSION}"
  
  if [[ ! -d "$NDK_DIR" ]]; then
    msg2 "üì¶ Downloading Android NDK ${NDK_VERSION}..."
    curl -L "$NDK_URL" -o "$srcdir/ndk.zip"
    unzip -q "$srcdir/ndk.zip" -d "$srcdir"
    rm "$srcdir/ndk.zip"
  fi
  
  NDK_LLVM="$NDK_DIR/toolchains/llvm/prebuilt/linux-x86_64"
  export PATH="$NDK_LLVM/bin:$PATH"
  msg2 "‚úÖ NDK LLVM tools ready: $(llvm-bolt --version 2>&1 | head -1 || echo 'not found')"

  # === 1. ÁéØÂ¢ÉÂáÜÂ§á ===
  export CC=clang
  export CXX=clang++
  export LDFLAGS="-fuse-ld=lld"

  # === 2. Stage 1: PGO ÊèíÊ°©ÁºñËØë ===
  msg2 "üöÄ Starting PGO Stage 1: Instrumentation..."
  rm -rf build-pgo
  export RUSTFLAGS="-Cprofile-generate=$srcdir/pgo_data -Ctarget-cpu=native"

  cmake -B build-pgo -S fish-shell -G Ninja \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=Release \
    -DWITH_MESSAGE_LOCALIZATION=OFF
  cmake --build build-pgo

  # === 3. Stage 2: PGO Training ===
  msg2 "üèãÔ∏è Training Fish (PGO)..."
  export LLVM_PROFILE_FILE="$srcdir/pgo_data/fish-%p-%m.profraw"
  echo 'for i in (seq 1 5000); string match -r ".*" "test_$i" >/dev/null; end' > train.fish

  for i in {1..20}; do
    ./build-pgo/fish --no-config train.fish > /dev/null 2>&1 || true
    ./build-pgo/fish --no-config -c "complete -C 'git comm'" > /dev/null 2>&1 || true
  done

  # === 4. Stage 3: PGO Use + Fat LTO ===
  msg2 "üî• Starting Stage 3: Extreme Compilation..."
  # Use system llvm-profdata (NDK version is too old for profile format v10)
  /usr/bin/llvm-profdata merge -output="$srcdir/fish.profdata" "$srcdir/pgo_data"

  export RUSTFLAGS="-Cprofile-use=$srcdir/fish.profdata -Ctarget-cpu=native -Clto=fat -Ccodegen-units=1 -Cpanic=abort -Clink-arg=-Wl,--emit-relocs"
  rm -rf build-pgo

  cmake -B build-pgo -S fish-shell -G Ninja \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=Release \
    -DWITH_MESSAGE_LOCALIZATION=OFF
  cmake --build build-pgo

  # === 5. Stage 4: BOLT Optimization ===
  msg2 "‚ö° Starting BOLT Optimization..."

  # Create instrumented binary
  msg2 "Creating BOLT instrumented binary..."
  if ! llvm-bolt build-pgo/fish -o fish.inst \
    -instrument \
    -instrumentation-file="$srcdir/bolt_data/fish.fdata" \
    -instrumentation-file-append-pid; then
    msg2 "‚ö†Ô∏è BOLT instrumentation failed, skipping BOLT"
    return 0
  fi

  # Run training
  msg2 "Training BOLT instrumented binary..."
  ./fish.inst --no-config -c 'echo "BOLT training"' 2>/dev/null || true
  ./fish.inst --no-config -c 'for i in (seq 1 100); echo $i >/dev/null; end' 2>/dev/null || true
  ./fish.inst --no-config -c 'string match -r ".*" "hello world"' 2>/dev/null || true
  ./fish.inst --no-config train.fish 2>/dev/null || true
  
  # Merge profile data
  if ls "$srcdir/bolt_data"/fish.fdata.* &>/dev/null; then
    merge-fdata "$srcdir/bolt_data"/fish.fdata.* > "$srcdir/bolt_data/fish.fdata.merged"
    mv "$srcdir/bolt_data/fish.fdata.merged" "$srcdir/bolt_data/fish.fdata"
  fi

  # Apply BOLT
  if [[ -s "$srcdir/bolt_data/fish.fdata" ]]; then
    msg2 "Applying BOLT optimizations..."
    if llvm-bolt build-pgo/fish -o fish.bolt \
      -data="$srcdir/bolt_data/fish.fdata" \
      -reorder-blocks=ext-tsp \
      -reorder-functions=hfsort \
      -split-functions \
      -split-all-cold \
      -icf=1 \
      -dyno-stats; then
      mv fish.bolt build-pgo/fish
      msg2 "‚úÖ BOLT optimization complete!"
    else
      msg2 "‚ö†Ô∏è BOLT optimization failed, using PGO binary"
    fi
  else
    msg2 "‚ö†Ô∏è No BOLT profile data, skipping"
  fi
}

package() {
  DESTDIR="$pkgdir" cmake --install build-pgo
}
