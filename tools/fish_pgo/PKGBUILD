# Maintainer: neycrol <330578697@qq.com>
pkgname=fish-git-pgo-bolt
pkgver=4.2.1.r226.g67d78fb25
pkgrel=1
pkgdesc="Fish Shell (Rust) - PGO + Fat LTO + Codegen=1 + BOLT Optimized"
arch=(x86_64)
url="https://fishshell.com"
license=(GPL2)
depends=(glibc gcc-libs ncurses pcre2)
makedepends=(git cmake ninja unzip clang llvm lld rust) # uses Android NDK for llvm-bolt
provides=(fish)
conflicts=(fish fish-git)
source=("git+https://github.com/fish-shell/fish-shell.git")
sha256sums=('SKIP')

pkgver() {
  cd fish-shell
  git describe --long --tags | sed 's/^//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  # ÂáÜÂ§á BOLT Êï∞ÊçÆÁõÆÂΩï
  mkdir -p "$srcdir/bolt_data"
}

build() {
  # === 0. Download Android NDK for LLVM tools (llvm-bolt, etc.) ===
  NDK_VERSION="r27c"
  NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
  NDK_DIR="$srcdir/android-ndk-${NDK_VERSION}"
  
  if [[ ! -d "$NDK_DIR" ]]; then
    msg2 "üì¶ Downloading Android NDK ${NDK_VERSION}..."
    curl -L "$NDK_URL" -o "$srcdir/ndk.zip"
    unzip -q "$srcdir/ndk.zip" -d "$srcdir"
    rm "$srcdir/ndk.zip"
  
  NDK_LLVM="$NDK_DIR/toolchains/llvm/prebuilt/linux-x86_64"
  export PATH="$NDK_LLVM/bin:$PATH"
  msg2 "‚úÖ NDK LLVM tools ready: $(llvm-bolt --version 2>&1 | head -1 || echo 'not found')"

  # === 1. ÁéØÂ¢ÉÂáÜÂ§á (‰ΩøÁî®Á≥ªÁªüÂ∑•ÂÖ∑) ===
  export CC=clang
  export CXX=clang++
  # Âº∫Âà∂‰ΩøÁî® LLD ÈìæÊé•Âô® (ÊîØÊåÅ BOLT ÊâÄÈúÄÁöÑÈáçÂÆö‰Ωç)
  export LDFLAGS="-fuse-ld=lld"

  # === 2. Stage 1: PGO ÊèíÊ°©ÁºñËØë ===
  msg2 "üöÄ Starting PGO Stage 1: Instrumentation..."
  rm -rf build-pgo

  # RUSTFLAGS Ê≥®ÂÖ•Ôºö
  # -Cprofile-generate: ÊèíÊ°©
  # -Ctarget-cpu=native: Áâ©ÁêÜÁâπÂåñ
  export RUSTFLAGS="-Cprofile-generate=$srcdir/pgo_data -Ctarget-cpu=native"

  cmake -B build-pgo -S fish-shell -G Ninja \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=Release \
    -DWITH_MESSAGE_LOCALIZATION=OFF

  cmake --build build-pgo

  # === 3. Stage 2: ÁâπËÆ≠ (PGO Training) ===
  msg2 "üèãÔ∏è‚Äç‚ôÇÔ∏è Training Fish (PGO)..."

  export LLVM_PROFILE_FILE="$srcdir/pgo_data/fish-%p-%m.profraw"

  # Ê®°ÊãüÈ´òÂº∫Â∫¶‰ΩøÁî®
  echo 'for i in (seq 1 5000); string match -r ".*" "test_$i" >/dev/null; end' > train.fish

  for i in {1..20}; do
    ./build-pgo/fish --no-config train.fish > /dev/null 2>&1
    ./build-pgo/fish --no-config -c "complete -C 'git comm'" > /dev/null 2>&1
    ./build-pgo/fish --no-config -c "exit" > /dev/null 2>&1
  done

  # === 4. Stage 3: ÊûÅÈôêÂèÇÊï∞ÁºñËØë (PGO Use + Fat LTO + Codegen=1) ===
  msg2 "üî• Starting Stage 3: Extreme Compilation..."

  # ÂêàÂπ∂ PGO Êï∞ÊçÆ
  llvm-profdata merge -output="$srcdir/fish.profdata" "$srcdir/pgo_data"

  # ÁªàÊûÅ Rust ÂèÇÊï∞Ôºö
  # -Cprofile-use: Ê≥®ÂÖ• PGO Êï∞ÊçÆ
  # -Clto=fat: ÂÖ®Â±ÄËÉñ LTO (ÊûÅËá¥‰ºòÂåñ)
  # -Ccodegen-units=1: ÂçïÁ∫øÁ®ã‰ª£Á†ÅÁîüÊàê (ÊûÅËá¥‰ºòÂåñ)
  # -Cpanic=abort: ÂéªÈô§ÂõûÊ∫Ø (ÊûÅËá¥Á≤æÁÆÄ)
  # -Clink-arg=-Wl,--emit-relocs: ‰øùÁïôÈáçÂÆö‰Ωç‰ø°ÊÅØ (‰∏∫ BOLT ÂÅöÂáÜÂ§á)
  export RUSTFLAGS="-Cprofile-use=$srcdir/fish.profdata -Ctarget-cpu=native -Clto=fat -Ccodegen-units=1 -Cpanic=abort -Clink-arg=-Wl,--emit-relocs"

  # Ê∏ÖÈô§ÊóßÊûÑÂª∫
  rm -rf build-pgo

  cmake -B build-pgo -S fish-shell -G Ninja \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=Release \
    -DWITH_MESSAGE_LOCALIZATION=OFF

  cmake --build build-pgo

  # === 5. Stage 4: BOLT Áâ©ÁêÜÈáçÊéí (Instrumentation Mode - no perf needed) ===
  msg2 "‚ö° Starting BOLT Optimization..."


  # 5.1 Create instrumented binary (no perf/sudo needed!)
  msg2 "Creating BOLT instrumented binary..."
  llvm-bolt build-pgo/fish -o fish.inst \
    -instrument \
    -instrumentation-file="$srcdir/bolt_data/fish.fdata" \
    -instrumentation-file-append-pid || {
      msg2 "BOLT instrumentation failed, skipping BOLT"
      return 0
    }

  # 5.2 Run instrumented binary with training workload
  msg2 "Training BOLT instrumented binary..."
  ./fish.inst --no-config -c 'echo "BOLT training"' 2>/dev/null || true
  ./fish.inst --no-config -c 'for i in (seq 1 100); echo $i >/dev/null; end' 2>/dev/null || true
  ./fish.inst --no-config -c 'string match -r ".*" "hello world"' 2>/dev/null || true
  ./fish.inst --no-config -c 'math "1+1"' 2>/dev/null || true
  ./fish.inst --no-config train.fish 2>/dev/null || true
  
  # Merge profile data if multiple files exist
  if ls "$srcdir/bolt_data"/fish.fdata.* &>/dev/null; then
    merge-fdata "$srcdir/bolt_data"/fish.fdata.* > "$srcdir/bolt_data/fish.fdata.merged"
    mv "$srcdir/bolt_data/fish.fdata.merged" "$srcdir/bolt_data/fish.fdata"

  # 5.3 Optimize with BOLT
  if [[ -s "$srcdir/bolt_data/fish.fdata" ]]; then
    msg2 "Applying BOLT optimizations..."
    llvm-build-pgo/fish -o fish.\
      -data="$srcdir/bolt_data/fish.fdata" \
      -reorder-blocks=ext-tsp \
      -reorder-functions=hfsort \
      -split-functions \
      -split-all-cold \
      -icf=1 \
      -dyno-stats || true
    
    if [[ -f fish.]]; then
      mv fish.build-pgo/fish
      msg2 "‚úÖ BOLT optimization complete!"
    else
      msg2 "‚ö†Ô∏è BOLT optimization failed, using PGO binary"
    fi
  else
    msg2 "‚ö†Ô∏è No BOLT profile data generated, skipping optimization"
}

package() {
  DESTDIR="$pkgdir" cmake --install build-pgo
}
