# Maintainer: neycrol <330578697@qq.com>
pkgname=prismlauncher-zlib-compat-git
_pkgname=PrismLauncher
pkgver=9.2.r10114.gbc6819289
pkgrel=1
pkgdesc="Prism Launcher (Git) bundled with vanilla zlib to fix hash mismatches on systems with zlib-ng (e.g. CachyOS)"
arch=('x86_64')
url="https://prismlauncher.org/"
license=('GPL-3.0-only')
depends=(
    'qt6-base'
    'qt6-5compat'
    'qt6-svg'
    'qt6-networkauth'
    'qt6-imageformats'
    'java-runtime'
    'glibc'
    'gcc-libs'
    'hicolor-icon-theme'
    'cmark'
    'tomlplusplus'
    'quazip-qt6'
    'gamemode'
)
makedepends=(
    'cmake'
    'extra-cmake-modules'
    'git'
    'jdk8-openjdk'   # Essential: Required to compile legacy Java components (JavaCheck.jar)
    'scdoc'
    'clang'
    'ninja'
    'vulkan-headers'
)
provides=('prismlauncher')
conflicts=('prismlauncher' 'prismlauncher-git' 'prismlauncher-bin')
source=(
    "${_pkgname}::git+https://github.com/PrismLauncher/PrismLauncher.git"
    "zlib::git+https://github.com/madler/zlib.git"
)
sha256sums=('SKIP' 'SKIP')

pkgver() {
    cd "$_pkgname"
    printf "9.2.r%s.g%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "$_pkgname"
    # Initialize submodules to ensure dependencies like libnbt++ are present
    git submodule update --init --recursive
}

build() {
    # --- 1. Build vanilla zlib (Private Compatibility Library) ---
    msg2 "Building vanilla zlib for compatibility..."
    cd "$srcdir/zlib"
    git clean -dfx
    # Force PIC (Position Independent Code) for linking into shared object
    CFLAGS="$CFLAGS -fPIC" ./configure --prefix="$srcdir/zlib_build"
    make
    make install

    # --- 2. Build Prism Launcher ---
    msg2 "Building Prism Launcher..."
    cd "$srcdir/$_pkgname"
    
    # Force usage of JDK 8 for compilation.
    # Newer JDKs (21+) dropped support for '-source 7', causing build failures for JavaCheck.jar.
    export JAVA_HOME="/usr/lib/jvm/java-8-openjdk"
    export PATH="$JAVA_HOME/bin:$PATH"
    
    msg2 "Using Build Java: $(java -version 2>&1 | head -n 1)"

    # Configure CMake
    # DJARS_DEST_DIR: Explicitly set to 'share/PrismLauncher' (CamelCase) to match
    # the hardcoded relative path lookup found via strace.
    cmake -B build -G Ninja \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DLauncher_BUILD_PLATFORM="Archlinux/CachyOS" \
        -DLauncher_QT_VERSION_MAJOR="6" \
        -DJAVA_HOME="$JAVA_HOME" \
        -DCMAKE_INSTALL_DATADIR="share" \
        -DJARS_DEST_DIR="share/PrismLauncher" \
        -Wno-dev

    cmake --build build
}

package() {
    cd "$srcdir/$_pkgname"
    
    # 1. Install main application
    DESTDIR="$pkgdir" cmake --install build

    # 2. [CRITICAL FIX] Manually enforce JAR placement
    # CMake installation logic can be inconsistent with variable expansion.
    # We manually install the JARs to the exact path the binary expects: /usr/share/PrismLauncher/
    msg2 "Enforcing correct JAR placement..."
    install -dm755 "$pkgdir/usr/share/PrismLauncher"
    
    find build -name "JavaCheck.jar" -exec install -Dm644 {} "$pkgdir/usr/share/PrismLauncher/JavaCheck.jar" \;
    find build -name "NewLaunch.jar" -exec install -Dm644 {} "$pkgdir/usr/share/PrismLauncher/NewLaunch.jar" \;
    find build -name "NewLaunchLegacy.jar" -exec install -Dm644 {} "$pkgdir/usr/share/PrismLauncher/NewLaunchLegacy.jar" \;

    # 3. Architecture Refactoring: Rename binary in-place
    # We keep the binary in /usr/bin so the relative lookup "../share/PrismLauncher" works correctly.
    msg2 "Setting up wrapper environment..."
    cd "$pkgdir/usr/bin"
    if [ -f prismlauncher ]; then
        mv prismlauncher prismlauncher-bin
    fi

    # 4. Install private zlib library
    install -dm755 "$pkgdir/usr/lib/prismlauncher/libs"
    cp -a "$srcdir/zlib_build/lib"/libz.so* "$pkgdir/usr/lib/prismlauncher/libs/"

    # 5. Create Wrapper Script
    # Prepends our vanilla zlib to LD_LIBRARY_PATH to bypass system zlib-ng hash mismatches
    msg2 "Creating wrapper script..."
    cat > prismlauncher <<EOF
#!/bin/sh
export LD_LIBRARY_PATH="/usr/lib/prismlauncher/libs\${LD_LIBRARY_PATH:+:\$LD_LIBRARY_PATH}"
exec /usr/bin/prismlauncher-bin "\$@"
EOF

    chmod 755 prismlauncher
    
    # 6. Install License
    cd "$srcdir/$_pkgname"
    install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
