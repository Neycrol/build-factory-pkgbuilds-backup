name: build-small

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
    env:
      REPO_NAME: buildfactory
      BINREPO_DIR: /work/binrepo
      PACKAGES_FILE: ci/packages-small.txt
      CPU_TARGET_FILE: ci/cpu-target.conf
      DEBUG_ENV: "1"
      GOD_GCC_URL: https://github.com/Neycrol/build-factory-pkgbuilds-backup/releases/download/gcc-git-god-16/gcc-git-god-16.0.0.r20251220-1-x86_64.pkg.tar.zst
      GOD_GCC_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Initialize pacman
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git sudo curl python jq

      - name: Create build user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Clone binary repo
        run: |
          git clone https://github.com/Neycrol/misaka-treasure-chest.git "$BINREPO_DIR"

      - name: Build packages
        env:
          BINREPO_TOKEN: ${{ secrets.BINREPO_TOKEN }}
          PUSH_EACH: "1"
          CLEAN_AFTER_BUILD: "1"
          CLEAN_SRCDEST: "1"
          CLEAN_PACMAN: "1"
        run: |
          chown -R builder:builder "$GITHUB_WORKSPACE" "$BINREPO_DIR"
          sudo -u builder -H env REPO_NAME="$REPO_NAME" BINREPO_DIR="$BINREPO_DIR" PACKAGES_FILE="$PACKAGES_FILE" CPU_TARGET_FILE="$CPU_TARGET_FILE" DEBUG_ENV="$DEBUG_ENV" GOD_GCC_URL="$GOD_GCC_URL" GOD_GCC_TOKEN="$GOD_GCC_TOKEN" BINREPO_TOKEN="$BINREPO_TOKEN" PUSH_EACH="$PUSH_EACH" CLEAN_AFTER_BUILD="$CLEAN_AFTER_BUILD" CLEAN_SRCDEST="$CLEAN_SRCDEST" CLEAN_PACMAN="$CLEAN_PACMAN" CI=true bash ci/build-small.sh

      - name: Push updated repo
        env:
          BINREPO_TOKEN: ${{ secrets.BINREPO_TOKEN }}
        run: |
          cd "$BINREPO_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add repo
          if git diff --cached --quiet; then
            echo "No repo changes."
            exit 0
          fi
          git commit -m "Update packages $(date -u +%Y-%m-%d)"
          git remote set-url origin "https://x-access-token:${BINREPO_TOKEN}@github.com/Neycrol/misaka-treasure-chest.git"
          git push
